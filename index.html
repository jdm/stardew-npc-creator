<script src="FileSaver.js"></script>
<script src="jszip.min.js"></script>
<style>
  .stuff {
      display: flex;
      flex-direction: column;
      align-items: left;
      padding: 1em;
  }

  .stuff div {
      padding: 0.2em;
  }

  #picker {
      display: block;
  }

  input[type="number"] {
      width: 3em;
  }

  .item-list span {
      display: inline-block;
      margin: 0.2em;
  }

  #tabs {
      display: flex;
      flex-direction: row;
      border: 1px solid black;
  }

  #tabs span {
      display: inline-block;
      padding: 0.5em 1em;
      cursor: pointer;
      background: lightgrey;
      border: 1px solid grey;
  }

  #tabs span:hover {
      color: white;
  }

  #tabs span.active {
      text-decoration: underline;
      font-weight: bold;
  }

  .hidden {
      display: none;
  }
</style>

<div id="tabs">
  <span id="tab-manifest" onclick="switchTab('manifest')">General</span>
  <span id="tab-disposition" onclick="switchTab('disposition')">Character</span>
  <span id="tab-gifts" onclick="switchTab('gifts')">Gifts</span>
  <span id="tab-schedule" onclick="switchTab('schedule')">Schedule</span>
  <span id="tab-dialogue" onclick="switchTab('dialogue')">Dialogue</span>
  <span id="tab-other" onclick="switchTab('other')">Other</span>
  <span id="tab-generate" onclick="switchTab('generate')">Generate</span>
</div>

<div id="manifest" class="stuff hidden">
  <div>
    <label for="modName">Mod name:</label>
    <input id="modName" required>
  </div>

  <div>
    <label for="author">Author:</label>
    <input id="author" required>
  </div>

  <div>
    <label for="description">Description:</label>
    <input id="description" required>
  </div>

  <div>
    <label for="version">Version:</label>
    <input id="version-major" type="number" value="1" min="1">.
    <input id="version-minor" type="number" value="0" min="0">.
    <input id="version-patch" type="number" value="0" min="0">
  </div>
</div>

<div id="disposition" class="stuff hidden">
  <div>
    <label for="npc-name">NPC's name:</label>
    <input id="npc-name" required>
  </div>

  <div>
    <label for="npc-age">Age:</label>
    <select id="npc-age">
      <option>child</option>
      <option>teen</option>
      <option>adult</option>
    </select>
  </div>

  <div>
    <label for="npc-manners">Manners:</label>
    <select id="npc-manners">
      <option>polite</option>
      <option>rude</option>
      <option>neutral</option>
    </select>
    <label for="npc-anxiety">Social anxiety:</label>
    <select id="npc-anxiety">
      <option>outgoing</option>
      <option>shy</option>
      <option>neutral</option>
    </select>
    <label for="npc-optimism">Optimism:</label>
    <select id="npc-optimism">
      <option>positive</option>
      <option>neutral</option>
      <option>negative</option>
    </select>
  </div>

  <div>
    <label for="npc-gender">Gender:</label>
    <select id="npc-gender">
      <option>male</option>
      <option>female</option>
    </select>
  </div>

  <div>
    <label for="npc-datable">Datable:</label>
    <input id="npc-datable" type="checkbox">
  </div>

  <div>
    <label for="npc-home">Home:</label>
    <select id="npc-home">
      <option>Town</option>
      <option>Desert</option>
      <option>Other</option>
    </select>
  </div>

  <div>
    <label for="npc-birthday-season">Birthday:</label>
    <select id="npc-birthday-season" class="season-picker">
    </select>
    <select id="npc-birthday-date" class="date-picker"></select>
  </div>

  <div>
    <label>(optional)</label>
    <label for="npc-mother">Mother:</label>
    <input id="npc-mother">
    <label for="npc-father">Father:</label>
    <input id="npc-father">
  </div>

  <div>
    <label for="npc-default-map">Default map and position:</label>
    <input type="hidden" id="npc-default-map">
    <input type="hidden" id="npc-default-x">
    <input type="hidden" id="npc-default-y">
    <span id="default-position"></span>
    <button onclick="createDefaultPosChooser()">Choose position</button>
  </div>

</div>

<div id="gifts" class="stuff hidden">
  <div>
    <label for="npc-gift-love-text">Gift love response:</label>
    <input id="npc-gift-love-text">
  </div>
  <div>
    <label for="npc-gift-love">Gift loves:</label>
    <ul class="item-list" id="npc-gift-love"></ul>
  </div>
  <div>
    <label for="npc-gift-like-text">Gift like response:</label>
    <input id="npc-gift-like-text">
  </div>
  <div>
    <label for="npc-gift-like">Gift likes:</label>
    <ul class="item-list" id="npc-gift-like"></ul>
  </div>
  <div>
    <label for="npc-gift-dislike-text">Gift dislike response:</label>
    <input id="npc-gift-dislike-text">
  </div>
  <div>
    <label for="npc-gift-dislike">Gift dislikes:</label>
    <ul class="item-list" id="npc-gift-dislike"></ul>
  </div>
  <div>
    <label for="npc-gift-hate-text">Gift hate response:</label>
    <input id="npc-gift-hate-text">
  </div>
  <div>
    <label for="npc-gift-hate">Gift hates:</label>
    <ul class="item-list" id="npc-gift-hate"></ul>
  </div>
  <div>
    <label for="npc-birthday-gift-text">Birthday gift response:</label>
    <input id="npc-birthday-gift-text">
  </div>

  <div style="margin-top: 1em;">
    <label for="items">Items:</label>
    <select id="items"></select>
    <br>
    <button onclick="addItem('npc-gift-love')">Add love</button>
    <button onclick="addItem('npc-gift-like')">Add like</button>
    <button onclick="addItem('npc-gift-dislike')">Add dislike</button>
    <button onclick="addItem('npc-gift-hate')">Add hate</button>
  </div>
</div>

<div id="schedule" class="stuff">
  <div id="schedules-all">
    <h5>All scheduled actions</h5>
    <ul id="schedules-list">
    </ul>
    <button onclick="newSchedule()">Add new schedule</button>
  </div>
  <div id="schedule-new" class="hidden">
    <h5>When does this schedule run?</h5>
    <select id="schedule-type" onchange="scheduleTypeChanged()">
      <option value="seasonal">Every day in a season</option>
      <option value="day-of-week">Day of week, all seasons</option>
      <option value="day-of-week-season">Day of week, single season</option>
      <option value="month-day">Day of month, all seasons</option>
      <option value="season-day">Day of month, single season</option>
      <option value="rain">Rainy day</option>
      <!-- TODO: marriage schedules !-->
    </select>
    <div>
      <select id="schedule-season" class="season-picker schedule-type-selector hidden">
      </select>
      <select id="schedule-date" class="date-picker schedule-type-selector hidden">
      </select>
      <select id="schedule-day" class="day-picker schedule-type-selector hidden">
      </select>
    </div>
    <h5>Actions</h5>
    <ol id="schedule-components">
    </ol>
    <button onclick="addScheduleComponent()">Add schedule action</button>
    <br><br>
    <button id="finishSchedule" onclick="finishSchedule()">Finish schedule</button>
    <button onclick="discardSchedule()">Discard schedule</button>
  </div>
</div>

<div id="dialogue" class="stuff hidden">
  <div id="dialogue-all">
    <ul id="dialogue-list">
    </ul>
    <br>
    <button onclick="addDialogue()">Add new dialogue</button>
  </div>
  <div id="dialogue-new" class="hidden">
    <h4>When will be the dialogue be used?</h4>
    <select id="dialogue-type" onchange="dialogueTypeChanged()">
      <option value="intro">One-time introduction</option>
      <option value="day">Day of week, all seasons</option>
      <option value="day-season">Day of week, particular season</option>
      <option value="date-season">Specific date in particular season</option>
      <!-- TODO: support marriage-related dialogue -->
      <!-- TODO: support danceRejection, divorced, [location]_Entry -->
      <!-- TODO: support [location]_[x]_[y], [location]_[dayName], [location] -->
      <!-- TODO: support hearts -->
      <!-- TODO: support first or later year -->
    </select>
    <div>
      <select id="dialogue-season" class="season-picker dialogue-type-selector hidden">
      </select>
      <select id="dialogue-day" class="day-picker dialogue-type-selector hidden">
      </select>
      <select id="dialogue-date" class="date-picker dialogue-type-selector hidden">
      </select>
    </div>
    <div id="dialogue-palette" class="hidden">
      <h5>Special replacements</h5>
      <button onclick="insertReplacer(this)" replacer="@">Player name</button>
      <button onclick="insertReplacer(this)" replacer="{{NPC}}">NPC name</button>
      <button onclick="insertReplacer(this)" replacer="%adj">Random adjective</button>
      <button onclick="insertReplacer(this)" replacer="%noun">Random noun</button>
      <button onclick="insertReplacer(this)" replacer="%place">Random place name</button>
      <button onclick="insertReplacer(this)" replacer="%spouse">Player's spouse name</button>
      <button onclick="insertReplacer(this)" replacer="%name">Random name</button>
      <button onclick="insertReplacer(this)" replacer="%firstnameletter">Player nickname</button>
      <button onclick="insertReplacer(this)" replacer="%time">Current time</button>
      <button onclick="insertReplacer(this)" replacer="%band">Sam's band name</button>
      <button onclick="insertReplacer(this)" replacer="%book">Elliot's book name</button>
      <button onclick="insertReplacer(this)" replacer="%rival">Random same-gender name</button>
      <button onclick="insertReplacer(this)" replacer="%pet">Pet name</button>
      <button onclick="insertReplacer(this)" replacer="%farm">Farm name</button>
      <button onclick="insertReplacer(this)" replacer="%favorite">Player's favorite</button>
      <button onclick="insertReplacer(this)" replacer="%kid1">First child name</button>
      <button onclick="insertReplacer(this)" replacer="%kid2">Second child name</button>
    </div>
    <h5>Dialogue elements</h5>
    <ol id="dialogue-specific-list">
    </ol>
    <button onclick="addDialogueElement()">Add dialogue element</button>
    <br><br>
    <button id="dialogue-finalize" onclick="finalizeDialogue()">Finish dialogue</button>
    <button onclick="discardDialogue()">Discard</button>
  </div>
</div>

<div id="other" class="stuff hidden">
  <p>
    <label for="scheduleDialogue">ScheduleDialogue.json</label>
    <textarea id="scheduleDialogue">
{
	"spring.000": "Ahhhh!The sun feels great on my skin... I wish I could lay here forever!$7",
	"spring.001": "Saloons, bars, clubs, even taverns are a great place to get to know everyone.$1#$b#Super-Models tend to turn their nose up to the common rabble.$2#$b#I think a common person carries amazing secrets with them.#$b#A smart guy would diversify their experiences.^A smart lady like yourself would do best diversifying their experiences.#$b#That's why you're out here.. isn't it, @?$1",
	"spring.002": "I'm just waiting for my limo...",
}
    </textarea>

  <p>
    <label for="marriageDialogue">MarriageDialogue.json</label>
    <textarea id="marriageDialogue">
{    
	"Rainy_Day_0": "  ",
    "Rainy_Day_1": "  ",
    "Rainy_Day_2": "  ",
    "Rainy_Day_3": "  ",
    "Rainy_Day_4": "  ",
    "patio_NPCName": " You need to declare the spouse name. (Example: patio_Haley)",
    "Rainy_Day_NPCName": "Be sure to put your NPC's name.",
    "Rainy_Night_0": "  ",
    "Rainy_Night_1": "  ",
    "Rainy_Night_2": "  ",
    "Rainy_Night_3": "  ",
    "Rainy_Night_4": "  ",
    "Rainy_Night_5": "  ",
    "Rainy_Night_NPCName": "  ",
    "Indoor_Day_0": "  ",
    "Indoor_Day_1": "  ",
    "Indoor_Day_2": "  ",
    "Indoor_Day_3": "  ",
    "Indoor_Day_4": "  ",
    "Indoor_Day_NPCName": "  ",
    "Indoor_Night_0": "  ",
    "Indoor_Night_1": "  ",
    "Indoor_Night_2": "  ",
    "Indoor_Night_3": "  ",
    "Indoor_Night_4": "  ",
    "Indoor_Night_NPCName": "Don't forget to fill in your NPC's Name",
    "Outdoor_0": "  ",
    "Outdoor_1": "  ",
    "Outdoor_2": "  ",
    "Outdoor_3": "  ",
    "Outdoor_4": "  ",
    "Outdoor_NPCName": "Don't forget to fill in your NPC's Name",
    "funLeave_NPCName": "Don't forget to fill in your NPC's Name",
    "funReturn_NPCName": "Don't forget to fill in your NPC's Name",
    "OneKid_3": "You can have 3 of these",
    "TwoKids_0": "  ",
    "TwoKids_2": "  ",
    "TwoKids_3": "  ",
    "Good_1": "  ",
    "Good_2": "  ",
    "Good_3": "  ",
    "Good_4": "  ",
    "Good_5": "  ",
    "Good_6": "  ",
    "Good_7": "  ",
    "Neutral_0": "  ",
    "Neutral_1": "  ",
    "Neutral_6": "  ",
    "Neutral_7": "  ",
    "Neutral_8": "  ",
    "Neutral_9": "  ",
    "Bad_7": "  ",
    "Bad_8": "  ",
    "Bad_9": "  ",

}
    </textarea>
</div>

<div class="stuff" id="generate">
  <h3>Generate a <a href="https://www.nexusmods.com/stardewvalley/mods/1915">ContentPatcher</a>-compatible mod</h3>
  <p>This will create a ZIP containing the appropriate NPC data files,
    ready to be unzipped in your Stardew Valley <a href="https://stardewvalleywiki.com/Modding:Player_Guide/Getting_Started#Install_mods">mod folder.</a></p>
  <p>Requirements:
    <ul>
      <li>SMAPI</li>
      <li>ContentPatcher</li>
    </ul>
  <button onclick="generate()">Create content pack</button>
</div>

<div class="stuff hidden" id="picker">
</div>

<script>
  var itemsXhr = new XMLHttpRequest();
  itemsXhr.responseType = 'json';
  itemsXhr.onload = function() {
      var items = document.querySelector('#items');
      var itemsData = itemsXhr.response['content'];
      for (const item of Object.keys(itemsData)) {
          var option = document.createElement('option');
          option.value = item;
          option.textContent = itemsData[item].split('/')[0];
          items.appendChild(option);
      }
  };
  itemsXhr.onerror = function(e) {
      console.error(e);
  };
  itemsXhr.open("GET", "ObjectInformation.json", true);
  itemsXhr.send();

  function addItem(id) {
      var elem = document.createElement('li');
      var inner = document.createElement('span');
      inner.className = "item-value";
      var items = document.querySelector('#items');
      inner.value = items.value;
      elem.textContent = items.options[items.selectedIndex].textContent;
      elem.appendChild(inner);
      var remover = document.createElement('button');
      remover.onclick = function() {
          this.parentNode.remove();
      };
      remover.textContent = "delete";
      elem.appendChild(remover);
      document.getElementById(id).appendChild(elem);
  }

  var allSchedules = [];
  function regenerateSchedules(schedules) {
      var list = document.querySelector("#schedules-list");
      list.innerHTML = "";
      for (const schedIdx in allSchedules) {
          const s = allSchedules[schedIdx];
          var item = document.createElement("li");
          const labels = {
              "seasonal": "Every day in {season}",
              "day-of-week": "Every {day}",
              "day-of-week-season": "Every {day} in {season}",
              "month-day": "Every day {date} in all seasons",
              "season-day": "Every day {date} in {season}",
              "rain": "Every rainy day",
          };
          var label = labels[s.type];
          for (const key of Object.keys(s.conditions)) {
              label = label.replace("{" + key + "}", s.conditions[key]);
          }
          item.appendChild(document.createTextNode(label));

          var edit = document.createElement("button");
          edit.textContent = "edit";
          edit.onclick = function(idx) {
              currentSchedule = {
                  elements: allSchedules[idx].elements,
              };
              currentScheduleIdx = idx;
              editSchedule(allSchedules[idx].type, allSchedules[idx].conditions);
          }.bind(null, schedIdx);
          item.appendChild(edit);

          var deleteButton = document.createElement("button");
          deleteButton.textContent = "delete";
          deleteButton.onclick = function(idx) {
              allSchedules.splice(idx, 1);
              regenerateSchedules();
          }.bind(null, schedIdx);
          item.appendChild(deleteButton);

          list.appendChild(item);
      }
  }

  function coordToTileCoord(coord) {
      return {
          x: Math.trunc(coord.x / 16) * 16,
          y: Math.trunc(coord.y / 16) * 16,
      };
  }

  function redrawMap(ctx, map, hovered, selected) {
      ctx.globalAlpha = 1.0;
      ctx.canvas.width = mapImages[map].width
      ctx.canvas.height = mapImages[map].height;
      ctx.drawImage(mapImages[map], 0, 0);
      if (hovered) {
          var tile = coordToTileCoord(hovered);
          ctx.globalAlpha = 0.4;
          ctx.fillStyle = "white";
          ctx.fillRect(tile.x, tile.y, 16, 16);
      }
      if (selected) {
          ctx.globalAlpha = 0.4;
          ctx.fillStyle = "red";
          var tile = coordToTileCoord(selected);
          ctx.fillRect(tile.x, tile.y, 16, 16);
          ctx.strokeStyle = "white";
          ctx.strokeRect(tile.x, tile.y, 16, 16);
      }
  }

  function canvasMouseCoordinates(canvas, evt) {
      var rect = canvas.getBoundingClientRect();
      return {
          x: evt.clientX - rect.left,
          y: evt.clientY - rect.top
      };
  }

  var mapImages = {};
  var maps = ["Town", "Beach", "Mountain", "BusStop", "Forest", "Saloon", "Backwoods"];
  for (const m of maps) {
      mapImages[m] = new Image();
      mapImages[m].src = m + ".png";
  }
  var selectedCoords = null;

  function generate() {
      var manifest = {};
      manifest["Name"] = document.querySelector('#modName').value;
      manifest["Author"] = document.querySelector('#author').value;
      manifest["Description"] = document.querySelector('#description').value;
      manifest["Version"] = document.querySelector('#version-major').value + '.' +
          document.querySelector('#version-minor').value + '.' +
          document.querySelector('#version-patch').value;
      manifest["UniqueID"] = manifest["Author"].replace(' ', '_') + "." +
          manifest["Name"].replace(' ', '_');
      manifest["ContentPackFor"] = { "UniqueID": "Pathoschild.ContentPatcher" };
      manifest["UpdateKeys"] = [ "" ];

      var content = {};
      content["Format"] = "1.9";
      var changes = [];

      var manifestationEntries = {};
      var npcName = document.querySelector("#npc-name").value;
      manifestationEntries[npcName] = [
          document.querySelector('#npc-age').value,
          document.querySelector('#npc-manners').value,
          document.querySelector('#npc-anxiety').value,
          document.querySelector('#npc-optimism').value,
          document.querySelector('#npc-gender').value,
          document.querySelector('#npc-datable').checked ? "datable" : "not-datable",
          "",
          document.querySelector('#npc-home').value,
          document.querySelector('#npc-birthday-season').value + " " +
              document.querySelector("#npc-birthday-date").value,
          (document.querySelector('#npc-mother').value ?
           document.querySelector('#npc-mother').value + " 'mom' " : "") +
              (document.querySelector('#npc-father').value ?
               document.querySelector('#npc-father').value + " 'dad'" : ""),
          document.querySelector('#npc-default-map').value + " " +
              document.querySelector('#npc-default-x').value + " " +
              document.querySelector('#npc-default-y').value,
          npcName,
      ].join('/');

      changes.push({
          "LogName": "NPC Manifestation",
          "Action": "EditData",
          "Target": "Data/NPCDispositions",
          "Entries": manifestationEntries,
      });

      function appendItems(list, id) {
          list.push(document.getElementById(id + '-text').value);
          var items = [];
          var allItems = document.querySelectorAll('#' + id + ' li span.item-value');
          for (const e of allItems) {
              items.push(e.value);
          }
          list.push(items.join(' '));
      }

      var giftEntries = {};
      giftEntries[npcName] = [];
      var lists = ['npc-gift-love', 'npc-gift-like', 'npc-gift-dislike', 'npc-gift-hate'];
      for (const list of lists) {
          appendItems(giftEntries[npcName], list)
      }
      giftEntries[npcName].push(document.querySelector('#npc-birthday-gift-text').value);
      giftEntries[npcName] = giftEntries[npcName].join('/');

      changes.push({
          "LogName": "NPC Gift Tastes",
          "Action": "EditData",
          "Target": "Data/NPCGiftTastes",
          "Entries": giftEntries,
      });

      changes.push({
          "LogName": "Animations",
          "Action": "EditData",
          "Target": "Data/animationDescriptions",
          "Entries": {}, // TODO
      });

      changes.push({
          "LogName": "EngagementDialogue",
          "Action": "EditData",
          "Target": "Data/EngagementDialogue",
          "Entries": {}, // TODO
      });

      changes.push({
          "LogName": "Schedule Dialogue",
          "Action": "Load",
          "Target": "Strings/schedules/" + npcName,
          "FromFile": "assets/Schedule/ScheduleDialogue.json",
      });

      // FIXME: support uploading arbitrary portrait image
      changes.push({
          "LogName": npcName + " Portraits",
          "Action": "Load",
          "Target": "Portraits/" + npcName,
          "FromFile": "assets/Image/" + npcName + ".png",
      });

      // FIXME: support uploading arbitrary sprite image
      changes.push({
          "LogName": npcName + " Sprites",
          "Action": "Load",
          "Target": "Characters/" + npcName,
          "FromFile": "assets/Image/" + npcName + "Sprites.png",
      });

      changes.push({
          "LogName": "Dialogue",
          "Action": "Load",
          "Target": "Characters/Dialogue/" + npcName,
          "FromFile": "assets/Dialogue/Dialogue.json",
      });

      changes.push({
          "LogName": "Schedule",
          "Action": "Load",
          "Target": "Characters/schedules/" + npcName,
          "FromFile": "assets/Schedule/Schedule.json",
      });

      // TODO: events

      content["Changes"] = changes;

      var scheduleData = {};
      var rainIndex = null;
      for (const schedule of allSchedules) {
          const keys = {
              "seasonal": ["season"],
              "day-of-week": ["day"],
              "day-of-week-season": ["season", "day"],
              "month-day": ["date"],
              "season-day": ["season", "date"],
              "rain": [],
          };
          console.log(schedule);
          var name = keys[schedule.type].map((k) => schedule.conditions[k]).join("_");
          if (schedule.type == "rain") {
              name = "rain";
              if (rainIndex !== null) {
                  name += rainIndex;
                  rainIndex += 1;
              } else {
                  rainIndex = 2;
              }
          }
          scheduleData[name] = schedule.elements.map((e) => {
              var elements = [
                  e.hour.toString() + e.minute.toString(),
                  e.map,
                  e.x,
                  e.y,
                  e.facing,
              ];
              if (e.animation != null) {
                  elements.push(e.animation);
              }
              return elements.join(' ');
          }).join('/');
      }

      var dialogueData = {};
      for (const dialogueIdx in dialogues) {
          const dialogue = dialogues[dialogueIdx];
          const name = {
              "intro": () => ["Introduction"],
              "day": () => [dialogue.conditions.day],
              "day-season": () => [dialogue.conditions.season, dialogue.conditions.day],
              "date-season": () => [dialogue.conditions.season, dialogue.conditions.date],
          };
          var dialogueEntry = "";
          for (const element of dialogue.elements) {
              dialogueEntry += element.text.replace("{{NPC}}", npcName);
              if (element.portrait !== "") {
                  dialogueEntry += "$" + element.portrait + "#";
              }
              if (dialogueIdx < dialogues.length - 1) {
                  if (element.isBreak) {
                      dialogueEntry += "$e#";
                  } else {
                      dialogueEntry += "$b#";
                  }
              }
          }
          var entryName = name[dialogue.type]().join('_');
          dialogueData[entryName] = dialogueEntry;
      }

      var scheduleDialogue = document.querySelector('#scheduleDialogue').textContent;
      var marriageDialogue = document.querySelector('#marriageDialogue').textContent;

      var zip = new JSZip();
      zip.file("manifest.json", JSON.stringify(manifest, undefined, 4));
      zip.file("content.json", JSON.stringify(content, undefined, 4));
      var assets = zip.folder("assets");
      var scheduleDir = assets.folder("Schedule");
      scheduleDir.file("Schedule.json", JSON.stringify(scheduleData, undefined, 4));
      scheduleDir.file("ScheduleDialogue.json", scheduleDialogue);
  
      var dialogueDir = assets.folder("Dialogue");
      dialogueDir.file("Dialogue.json", JSON.stringify(dialogueData, undefined, 4));
      dialogueDir.file("MarriageDialogue.json", marriageDialogue);

      var image = assets.folder("Image");

      zip.generateAsync({type:"blob"})
          .then(function(content) {
              saveAs(content, "example.zip");
          });
  }

  function switchTab(id) {
      var tabs = document.querySelectorAll('.stuff');
      for (const tab of tabs) {
          tab.classList.add("hidden");
      }
      document.getElementById(id).classList.remove("hidden");
      var tabs = document.querySelectorAll('#tabs span');
      for (const tab of tabs) {
          tab.classList.remove('active');
      }
      document.getElementById("tab-" + id).classList.add("active");
  }

  var currentSchedule;
  var currentScheduleIdx = null;
  function newSchedule() {
      currentSchedule = {
          elements: [],
      };
      currentScheduleIdx = null;
      editSchedule();
  }

  function editSchedule(type, keys) {
      document.querySelector("#schedules-all").classList.add("hidden");
      document.querySelector("#schedule-new").classList.remove("hidden");
      if (type !== undefined) {
          var types = document.querySelector("#schedule-type");
          for (const idx in types.options) {
              if (types.options[idx].value == type) {
                  types.selectedIndex = idx;
              }
          }
          for (const k of Object.keys(keys)) {
              var select = document.getElementById("schedule-" + k);
              for (const idx in select.options) {
                  if (select.options[idx].value == keys[k]) {
                      select.selectedIndex = idx;
                  }
              }
          }
      }
      scheduleTypeChanged();
      recreateSchedule();
  }

  function scheduleTypeChanged() {
      var selected = document.querySelector("#schedule-type").value;
      var selectors = document.querySelectorAll('.schedule-type-selector');
      for (const s of selectors) {
          s.classList.add('hidden');
      }
      const components = {
          "seasonal": ["schedule-season"],
          "day-of-week": ["schedule-day"],
          "day-of-week-season": ["schedule-season", "schedule-day"],
          "month-day": ["schedule-date"],
          "season-day": ["schedule-season", "schedule-date"],
          "rain": [],
      };
      for (const id of components[selected]) {
          document.getElementById(id).classList.remove('hidden');          
      }
  }

  function discardSchedule() {
      document.querySelector('#schedules-all').classList.remove("hidden");
      document.querySelector('#schedule-new').classList.add("hidden");
      currentSchedule = null;
      if (currentScheduleIdx !== null) {
          console.log("discarding existing schedule");
          allSchedules.splice(currentScheduleIdx, 1);
      }
      regenerateSchedules();
  }

  function addScheduleComponent() {
      var last = currentSchedule.elements.length > 0 ?
          currentSchedule.elements[currentSchedule.elements.length - 1] :
          null;
      currentSchedule.elements.push({
          hour: last ? last.hour : "6",
          minute: last ? last.minute : "00",
          map: last ? last.map : null,
          x: last ? last.x : null,
          y: last ? last.y : null,
          facing: 0,
          animation: null,
      });
      recreateSchedule();
  }

  // TODO: support reusing existing schedules with different conditions (GOTO)
  // TODO: support schedule friendship checks
  // TODO: support fallback conditions (eg. 11_6 in Abigail.json)
  // TODO: support scheduled dialogue

  function finishSchedule() {
      var selected = document.querySelector("#schedule-type").value;
      var season = document.querySelector("#schedule-season").value;
      var date = document.querySelector("#schedule-date").value;
      var day = document.querySelector("#schedule-day").value;
      const seasonalKinds = ["seasonal", "day-of-week-season", "season-day"];
      const dayKinds = ["day-of-week", "day-of-week-season"];
      const dateKinds = ["month-day", "season-day"];
      var schedule = {
          "type": selected,
          "conditions": {},
          "elements": currentSchedule.elements,
      };
      if (seasonalKinds.indexOf(selected) != -1) {
          schedule.conditions.season = season;
      }
      if (dayKinds.indexOf(selected) != -1) {
          schedule.conditions.day = day;
      }
      if (dateKinds.indexOf(selected) != -1) {
          schedule.conditions.date = date;
      }
      if (currentScheduleIdx === null) {
          allSchedules.push(schedule);
      } else {
          allSchedules[currentScheduleIdx] = schedule;
          currentScheduleIdx = null;
      }
      discardSchedule();
  }

  var currentScheduleElement = null;
  function recreateSchedule() {
      var list = document.querySelector("#schedule-components");
      list.innerHTML = "";
      var anyMissingPositions = false;
      for (const idx in currentSchedule.elements) {
          const c = currentSchedule.elements[idx];
          var item = document.createElement('li');

          var hour = document.createElement('select');
          hour.onchange = function(idx) {
              currentSchedule.elements[idx].hour = hour.value;
          }.bind(null, idx);
          for (var h = 0; h <= 24; h++) {
              var elem = document.createElement('option');
              if (h.toString() == currentSchedule.elements[idx].hour) {
                  elem.defaultSelected = true;
              }
              elem.textContent = h.toString();
              hour.appendChild(elem);
          }
          item.appendChild(hour);

          item.appendChild(document.createTextNode(':'));

          var minute = document.createElement('select');
          minute.onchange = function(idx) {
              currentSchedule.elements[idx].minute = minute.value;
          }.bind(null, idx);
          for (var m = 0; m < 60; m += 10) {
              var elem = document.createElement('option');
              minString = m.toString();
              if (minString.length < 2) {
                  minString = "0" + minString;
              }
              if (m.toString() == currentSchedule.elements[idx].minute) {
                  elem.defaultSelected = true;
              }
              elem.textContent = minString;
              minute.appendChild(elem);
          }
          item.appendChild(minute);

          if (currentSchedule.elements[idx].x !== null && currentSchedule.elements[idx].x !== null) {
              item.appendChild(document.createTextNode(
                  "at " + currentSchedule.elements[idx].x + ", " +
                      currentSchedule.elements[idx].y +
                      " (" + currentSchedule.elements[idx].map + ")"
              ));
          } else {
              anyMissingPositions = true;
          }

          var posSelect = document.createElement('button');
          posSelect.onclick = function(idx) {
              currentScheduleElement = currentSchedule.elements[idx];
              var defaultCoord = currentScheduleElement.x !== null ?
                  {
                      x: currentScheduleElement.x * 16,
                      y: currentScheduleElement.y * 16,
                  } :
                  null;
              createPositionChooser(
                  'schedule-new',
                  chooseSelectedPosition,
                  cancelChoosePosition,
                  currentScheduleElement.map,
                  defaultCoord,
              );
          }.bind(null, idx);
          posSelect.textContent = "Choose position";
          item.appendChild(posSelect);

          item.appendChild(document.createTextNode('facing'));

          var facing = document.createElement('select');
          facing.onchange = function() {
              currentSchedule.elements[idx].facing = facing.value;
          }.bind(null, idx);
          var dirs = ["up", "right", "down", "left"];
          for (var facingIdx in dirs) {
              var opt = document.createElement('option');
              if (facingIdx == currentSchedule.elements[idx].facing) {
                  opt.defaultSelected = true;
              }
              opt.value = facingIdx;
              opt.textContent = dirs[facingIdx];
              facing.appendChild(opt);
          }
          item.appendChild(facing);

          // TODO: show select for possible animations

          var deleteButton = document.createElement('button');
          deleteButton.textContent = "delete action";
          deleteButton.onclick = function(idx) {
              currentSchedule.elements.splice(idx, 1);
              recreateSchedule();
          }.bind(null, idx);
          item.appendChild(deleteButton);

          list.appendChild(item);
      }

      document.querySelector("#finishSchedule").disabled = anyMissingPositions;
  }

  function chooseSelectedPosition(map, coords) {
      currentScheduleElement.x = coords.x;
      currentScheduleElement.y = coords.y;
      currentScheduleElement.map = map;
      cancelChoosePosition()
  }

  function cancelChoosePosition() {
      currentScheduleElement = null;
      recreateSchedule();
  }

  function createDefaultPosChooser() {
      var defaultCoord = document.querySelector('#npc-default-x').value !== "" ?
          {
              x: parseInt(document.querySelector('#npc-default-x').value),
              y: parseInt(document.querySelector('#npc-default-y').value),
          } :
          null;
      createPositionChooser(
          'disposition',
          onDefaultPosChoose,
          onDefaultPosCancel,
          document.querySelector('#npc-default-map').value,
          defaultCoord,
      );
  }

  function onDefaultPosChoose(map, coord) {
      document.querySelector("#npc-default-x").value = coord.x;
      document.querySelector("#npc-default-y").value = coord.y;
      document.querySelector("#default-position").textContent = map + " at " + coord.x + ", " + coord.y;
  }

  function onDefaultPosCancel() {
  }

  function createPositionChooser(idToHide, onChoose, onCancel, defaultImage, defaultCoords) {
      document.getElementById(idToHide).classList.add('hidden');
      var picker = document.querySelector("#picker");
      picker.classList.remove('hidden');
      picker.innerHTML = "";

      var mapChooser = document.createElement('select');
      mapChooser.onchange = function() {
          selectedCoords = null;
          var buttons = document.querySelectorAll("button[pickerChoose]");
          for (const b of buttons) {
              b.disabled = true;
          }
          redrawMap(ctx, this.value, null, null);
      };
      for (const map of maps) {
          var opt = document.createElement('option');
          opt.textContent = map;
          opt.value = map;
          if (map == defaultImage) {
              opt.defaultSelected = true;
          }
          mapChooser.appendChild(opt);
      }
      var canvas = document.createElement('canvas');
      var ctx = canvas.getContext('2d');
      canvas.onmousemove = function(evt) {
          var coords = canvasMouseCoordinates(canvas, evt);
          redrawMap(ctx, mapChooser.value, coords, selectedCoords);
      };
      canvas.onclick = function(evt) {
          var coords = canvasMouseCoordinates(canvas, evt);
          selectedCoords = coords;

          var buttons = document.querySelectorAll("button[pickerChoose]");
          for (const b of buttons) {
              b.disabled = false;
          }
          redrawMap(ctx, mapChooser.value, coords, selectedCoords);
      };

      function restore() {
          picker.innerHTML = "";
          picker.classList.add('hidden');
          document.getElementById(idToHide).classList.remove('hidden');
      }

      var chooseButton = document.createElement('button');
      chooseButton.toggleAttribute('pickerChoose');
      chooseButton.onclick = function() {
          restore();
          var coords = coordToTileCoord(selectedCoords);
          onChoose(mapChooser.value, { x: coords.x / 16, y: coords.y / 16 });
      };
      chooseButton.disabled = true;
      chooseButton.textContent = "Choose selected position";

      var cancelButton = document.createElement('button');
      cancelButton.onclick = function() {
          restore();
          onCancel();
      }
      cancelButton.textContent = "Cancel";

      if (defaultCoords !== null) {
          selectedCoords = {
              x: defaultCoords.x * 16,
              y: defaultCoords.y * 16,
          };
      }

      picker.appendChild(mapChooser);
      picker.appendChild(chooseButton.cloneNode(true));
      picker.appendChild(cancelButton.cloneNode(true));
      picker.appendChild(document.createElement('br'));
      picker.appendChild(canvas);
      picker.appendChild(document.createElement('br'));
      picker.appendChild(chooseButton);
      picker.appendChild(cancelButton);
      redrawMap(ctx, mapChooser.value, null, null, false);
  }

  var dialogues = [];
  var currentDialogue = null;
  var currentDialogueIdx = null;
  function addDialogue() {
      currentDialogueIdx = null;
      currentDialogue = {
          type: null,
          conditions: {},
          elements: [],
      };
      showDialogueEditor();
  }

  function showDialogueEditor() {
      document.querySelector("#dialogue-all").classList.add('hidden');
      document.querySelector("#dialogue-new").classList.remove('hidden');

      for (const opt of document.querySelector("#dialogue-type").options) {
          if (opt.value == currentDialogue.type) {
              opt.selected = true;
          }
      }

      const keys = ["season", "day", "date"];
      for (const key of keys) {
          if (key in currentDialogue.conditions) {
              for (const opt of document.getElementById("dialogue-" + key).options) {
                  if (opt.value == currentDialogue.conditions[key]) {
                      opt.selected = true;
                  }
              }
          }
      }

      dialogueTypeChanged();
      recreateDialogue();
  }

  function dialogueTypeChanged() {
      var selected = document.querySelector("#dialogue-type").value;
      var selectors = document.querySelectorAll('.dialogue-type-selector');
      for (const s of selectors) {
          s.classList.add('hidden');
      }
      const components = {
          "intro": [],
          "day": ["dialogue-day"],
          "day-season": ["dialogue-day", "dialogue-season"],
          "date-season": ["dialogue-date", "dialogue-season"],
      };
      for (const id of components[selected]) {
          document.getElementById(id).classList.remove('hidden');
      }
  }

  function addDialogueElement() {
      currentDialogue.elements.push({
          text: "",
          portrait: "",
          isBreak: false,
      });
      recreateDialogue();
  }

  function finalizeDialogue() {
      var dialogueType = document.querySelector('#dialogue-type').value;
      const keys = {
          "intro": [],
          "day": ["day"],
          "day-season": ["day", "season"],
          "date-season": ["date", "season"],
      };
      currentDialogue.type = dialogueType;
      currentDialogue.conditions = {};
      for (const key of keys[dialogueType]) {
          currentDialogue.conditions[key] = document.getElementById('dialogue-' + key).value;
      }
      if (currentDialogueIdx !== null) {
          dialogues[currentDialogueIdx] = currentDialogue;
      } else {
          dialogues.push(currentDialogue);
      }
      discardDialogue();
  }

  function discardDialogue() {
      document.querySelector("#dialogue-new").classList.add('hidden');
      document.querySelector("#dialogue-all").classList.remove('hidden');
      currentDialogue = null;
      regenerateAllDialogues();
  }

  function recreateDialogue() {
      var list = document.querySelector("#dialogue-specific-list");
      list.innerHTML = "";
      document.querySelector("#dialogue-palette").classList.add('hidden');
      document.querySelector('#dialogue-finalize').disabled = true;

      for (const elementIdx in currentDialogue.elements) {
          document.querySelector('#dialogue-finalize').disabled = false;
          document.querySelector("#dialogue-palette").classList.remove('hidden');

          var element = currentDialogue.elements[elementIdx];
          var li = document.createElement("li");

          li.appendChild(document.createTextNode("Dialogue:"));
          var text = document.createElement("input");
          text.size = 40;
          text.value = element.text;
          text.onchange = function(idx) {
              currentDialogue.elements[idx].text = this.value;
          }.bind(text, elementIdx);
          text.onblur = function() {
              lastFocusedDialogue = this;
          };
          li.appendChild(text);

          li.appendChild(document.createTextNode("New portrait:"));

          var portrait = document.createElement("select");
          portrait.onchange = function(idx) {
              currentDialogue.elements[idx].portrait = this.value;
          }.bind(portrait, elementIdx);
          // TODO: support custom portraits
          const portraits = ["neutral", "happy", "sad", "unique", "love", "angry"];
          var opt = document.createElement("option");
          opt.textContent = "";
          portrait.appendChild(opt);
          for (const pIndex in portraits) {
              var opt = document.createElement("option");
              opt.textContent = portraits[pIndex];
              opt.value = pIndex;
              if (pIndex == element.portrait) {
                  opt.defaultSelected = true;
              }
              portrait.appendChild(opt);
          }
          li.appendChild(portrait);

          li.appendChild(document.createTextNode("End current dialogue?"));

          var isBreak = document.createElement("input");
          isBreak.type = "checkbox";
          isBreak.onchange = function(idx) {
              currentDialogue.elements[idx].isBreak = this.checked;
          }.bind(isBreak, elementIdx);
          isBreak.checked = element.isBreak;
          li.appendChild(isBreak);

          var deleteButton = document.createElement("button");
          deleteButton.textContent = "delete";
          deleteButton.onclick = function(idx) {
              currentDialogue.elements.splice(idx, 1);
              recreateDialogue();
          }.bind(deleteButton, elementIdx);
          li.appendChild(deleteButton);

          list.appendChild(li);
      }
  }

  function regenerateAllDialogues() {
      var list = document.querySelector("#dialogue-list");
      list.innerHTML = "";
      for (const dialogueIdx in dialogues) {
          const dialogue = dialogues[dialogueIdx];
          var li = document.createElement("li");

          const name = {
              "intro": () => "Introduction",
              "day": () => "Every " + dialogue.conditions.day,
              "day-season": () => dialogue.conditions.day + " in " + dialogue.conditions.season,
              "date-season": () => dialogue.conditions.season + " " + dialogue.conditions.date,
          };
          li.appendChild(document.createTextNode(name[dialogue.type]()));

          var editButton = document.createElement('button');
          editButton.textContent = "edit";
          editButton.onclick = function(idx) {
              editDialogue(dialogues[idx], idx);
          }.bind(editButton, dialogueIdx);
          li.appendChild(editButton);

          var deleteButton = document.createElement('button');
          deleteButton.textContent = "delete";
          deleteButton.onclick = function(idx) {
              dialogues.splice(idx, 1);
              regenerateAllDialogues();
          }.bind(editButton, dialogueIdx);
          li.appendChild(deleteButton);

          list.appendChild(li);
      }
  }

  function editDialogue(dialogue, idx) {
      currentDialogueIdx = idx;
      currentDialogue = {
          type: dialogue.type,
          conditions: Object.assign({}, dialogue.conditions),
          elements: dialogue.elements.slice(0),
      };
      showDialogueEditor();
  }

  var lastFocusedDialogue = null;
  function insertReplacer(source) {
      if (lastFocusedDialogue) {
          lastFocusedDialogue.value += source.getAttribute("replacer");
          // Firefox doesn't fire trusted onchange event for programmatic changes.
          lastFocusedDialogue.dispatchEvent(new Event('change'));
          lastFocusedDialogue.focus();
      }
  }

  var datePickers = document.querySelectorAll('.date-picker');
  for (const picker of datePickers) {
      for (var i = 1; i <= 28; i++) {
          var opt = document.createElement('option');
          opt.textContent = i;
          picker.appendChild(opt);
      }
  }

  var dayPickers = document.querySelectorAll('.day-picker');
  for (const picker of dayPickers) {
      const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
      for (const day of days) {
          var opt = document.createElement('option');
          opt.textContent = day;
          opt.value = day.slice(0, 3);
          picker.appendChild(opt);
      }
  }

  var seasonPickers = document.querySelectorAll('.season-picker');
  for (const picker of seasonPickers) {
      const seasons = ["spring", "summer", "fall", "winter"];
      for (const season of seasons) {
          var opt = document.createElement('option');
          opt.textContent = season;
          picker.appendChild(opt);
      }
  }

  switchTab('manifest');
</script>
