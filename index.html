<script src="FileSaver.js"></script>
<script src="jszip.min.js"></script>
<style>
  .stuff {
      display: flex;
      flex-direction: column;
      align-items: left;
      padding: 1em;
  }

  .stuff div {
      padding: 0.2em;
  }

  input[type="number"] {
      width: 3em;
  }

  .item-list span {
      display: inline-block;
      margin: 0.2em;
  }
  .item-remover:hover {
      text-decoration: underline;
      cursor: pointer;
  }

  #tabs {
      display: flex;
      flex-direction: row;
      border: 1px solid black;
  }

  #tabs span {
      display: inline-block;
      padding: 0.5em 1em;
      cursor: pointer;
      background: lightgrey;
      border: 1px solid grey;
  }

  #tabs span:hover {
      color: white;
  }

  #tabs span.active {
      text-decoration: underline;
      font-weight: bold;
  }

  .hidden {
      display: none;
  }
</style>

<div id="tabs">
  <span id="tab-manifest" onclick="switchTab('manifest')">General</span>
  <span id="tab-disposition" onclick="switchTab('disposition')">Character</span>
  <span id="tab-gifts" onclick="switchTab('gifts')">Gifts</span>
  <span id="tab-schedule" onclick="switchTab('schedule')">Schedule</span>
  <span id="tab-other" onclick="switchTab('other')">Other</span>
</div>

<div id="manifest" class="stuff hidden">
  <div>
    <label for="modName">Mod name:</label>
    <input id="modName">
  </div>

  <div>
    <label for="author">Author:</label>
    <input id="author">
  </div>

  <div>
    <label for="description">Description:</label>
    <input id="description">
  </div>

  <div>
    <label for="version">Version:</label>
    <input id="version-major" type="number" value="1" min="1">.
    <input id="version-minor" type="number" value="0">.
    <input id="version-patch" type="number" value="0">
  </div>
</div>

<div id="disposition" class="stuff hidden">
  <div>
    <label for="npc-name">NPC's name:</label>
    <input id="npc-name">
  </div>

  <div>
    <label for="npc-age">Age:</label>
    <select id="npc-age">
      <option>child</option>
      <option>teen</option>
      <option>adult</option>
    </select>
  </div>

  <div>
    <label for="npc-manners">Manners:</label>
    <select id="npc-manners">
      <option>polite</option>
      <option>rude</option>
      <option>neutral</option>
    </select>
    <label for="npc-anxiety">Social anxiety:</label>
    <select id="npc-anxiety">
      <option>outgoing</option>
      <option>shy</option>
      <option>neutral</option>
    </select>
    <label for="npc-optimism">Optimism:</label>
    <select id="npc-optimism">
      <option>positive</option>
      <option>neutral</option>
      <option>negative</option>
    </select>
  </div>

  <div>
    <label for="npc-gender">Gender:</label>
    <select id="npc-gender">
      <option>male</option>
      <option>female</option>
    </select>
  </div>

  <div>
    <label for="npc-datable">Datable:</label>
    <input id="npc-datable" type="checkbox">
  </div>

  <div>
    <label for="npc-home">Home:</label>
    <select id="npc-home">
      <option>Town</option>
      <option>Desert</option>
      <option>Other</option>
    </select>
  </div>

  <div>
    <label for="npc-birthday-season">Birthday:</label>
    <select id="npc-birthday-season">
      <option>spring</option>
      <option>summer</option>
      <option>fall</option>
      <option>winter</option>
    </select>
    <input id="npc-birthday-date" type="number" value="1" min="1" max="28">
  </div>

  <div>
    <label>(optional)</label>
    <label for="npc-mother">Mother:</label>
    <input id="npc-mother">
    <label for="npc-father">Father:</label>
    <input id="npc-father">
  </div>

  <div>
    <label for="npc-default-map">Default map and position:</label>
    <input id="npc-default-map">
    <input id="npc-default-x" type="number" value="0" min="0">
    <input id="npc-default-y" type="number" value="0" min="0">
  </div>

</div>

<div id="gifts" class="stuff hidden">
  <div>
    <label for="npc-gift-love-text">Gift love response:</label>
    <input id="npc-gift-love-text">
  </div>
  <div>
    <label for="npc-gift-love">Gift loves:</label>
    <ul class="item-list" id="npc-gift-love"></ul>
  </div>
  <div>
    <label for="npc-gift-like-text">Gift like response:</label>
    <input id="npc-gift-like-text">
  </div>
  <div>
    <label for="npc-gift-like">Gift likes:</label>
    <ul class="item-list" id="npc-gift-like"></ul>
  </div>
  <div>
    <label for="npc-gift-dislike-text">Gift dislike response:</label>
    <input id="npc-gift-dislike-text">
  </div>
  <div>
    <label for="npc-gift-dislike">Gift dislikes:</label>
    <ul class="item-list" id="npc-gift-dislike"></ul>
  </div>
  <div>
    <label for="npc-gift-hate-text">Gift hate response:</label>
    <input id="npc-gift-hate-text">
  </div>
  <div>
    <label for="npc-gift-hate">Gift hates:</label>
    <ul class="item-list" id="npc-gift-hate"></ul>
  </div>
  <div>
    <label for="npc-birthday-gift-text">Birthday gift response:</label>
    <input id="npc-birthday-gift-text">
  </div>

  <div>
    <label for="items">Items:</label>
    <select id="items"></select>
    <button onclick="addItem('npc-gift-love')">Add love</button>
    <button onclick="addItem('npc-gift-like')">Add like</button>
    <button onclick="addItem('npc-gift-dislike')">Add dislike</button>
    <button onclick="addItem('npc-gift-hate')">Add hate</button>
  </div>
</div>

<div id="schedule" class="stuff">
  <div id="schedules-all">
    <h5>All scheduled actions</h5>
    <ul id="schedules-list">
    </ul>
    <button onclick="newSchedule()">Add new schedule</button>
  </div>
  <div id="schedule-new" class="hidden">
    <h5>When does this schedule run?</h5>
    <select id="schedule-type" onchange="scheduleTypeChanged()">
      <option value="seasonal">Every day in a season</option>
      <option value="day-of-week">Day of week, all seasons</option>
      <option value="day-of-week-season">Day of week, single season</option>
      <option value="month-day">Day of month, all seasons</option>
      <option value="season-day">Day of month, single season</option>
      <option value="rain">Rainy day</option>
      <!-- TODO: marriage schedules !-->
    </select>
    <div>
      <select id="schedule-season" class="schedule-type-selector hidden">
        <option>spring</option>
        <option>summer</option>
        <option>fall</option>
        <option>winter</option>
      </select>
      <select id="schedule-date" class="schedule-type-selector hidden">
      </select>
      <select id="schedule-day" class="schedule-type-selector hidden">
        <option value="Mon">Monday</option>
        <option value="Tue">Tuesday</option>
        <option value="Wed">Wednesday</option>
        <option value="Thu">Thursday</option>
        <option value="Fri">Friday</option>
        <option value="Sat">Saturday</option>
        <option value="Sun">Sunday</option>
      </select>
    </div>
    <h5>Actions</h5>
    <ol id="schedule-components">
    </ol>
    <button onclick="addScheduleComponent()">Add schedule action</button>
    <br><br>
    <button onclick="finishSchedule()">Finish schedule</button>
    <button onclick="discardSchedule()">Discard schedule</button>
  </div>
  <div id="schedule-new-choose-position" class="hidden">
    <select id="mapImage" onchange="redrawMap(this.value, null, null, true)"></select><br>
    <canvas id="map"></canvas><br>
    <button onclick="chooseSelectedPosition()">Choose selected position</button>
    <button onclick="cancelChoosePosition()">Cancel</button>
  </div>
</div>

<div id="other" class="stuff hidden">
<!--  <p>
    <label for="schedule">Schedule.json</label>
    <textarea id="schedule">
{
	"spring": "610 BusStop 16 19 2/700 Town 37 89 2/1030 Beach 57 8 1 sunbathe \"Strings\\schedules\\Hiroshi:spring.000\"/1430 Saloon 9 20 0/1750 Saloon 39 19 2 martini \"Strings\\schedules\\Hiroshi:spring.001\"/2100 Saloon 26 23 3/2350 BusStop 22 5 2 \"Strings\\schedules\\Hiroshi:spring.002\"",
	"summer": "610 BusStop 22 5 2/800 Beach 10 13 2 sunbathe \"Strings\\schedules\\Hiroshi:summer.000\"/1430 Saloon 9 20 0/1750 Saloon 39 19 2 martini \"Strings\\schedules\\Hiroshi:summer.001\"/2100 Saloon 26 23 3/2350 BusStop 22 5 2 \"Strings\\schedules\\Hiroshi:summer.002\"",
	"fall": "600 BusStop 22 5 2/700 Town 37 89 2/1030 Beach 57 8 1/1430 Saloon 9 20 0/1750 Saloon 39 19 2/2100 Saloon 26 23 3/2350 BusStop 22 5 2",
	"winter": "600 BusStop 22 5 2/700 Saloon 9 20 0/1430 Saloon 9 20 0/1750 Saloon 39 19 2/2100 Saloon 26 23 3/2350 BusStop 22 5 2",
	"rain": "600 BusStop 22 5 2/700 Saloon 9 20 0/1430 Saloon 9 20 0/1750 Saloon 39 19 2/2100 Saloon 26 23 3/2350 BusStop 22 5 2",
}
    </textarea>-->

  <p>
    <label for="scheduleDialogue">ScheduleDialogue.json</label>
    <textarea id="scheduleDialogue">
{
	"spring.000": "Ahhhh!The sun feels great on my skin... I wish I could lay here forever!$7",
	"spring.001": "Saloons, bars, clubs, even taverns are a great place to get to know everyone.$1#$b#Super-Models tend to turn their nose up to the common rabble.$2#$b#I think a common person carries amazing secrets with them.#$b#A smart guy would diversify their experiences.^A smart lady like yourself would do best diversifying their experiences.#$b#That's why you're out here.. isn't it, @?$1",
	"spring.002": "I'm just waiting for my limo...",
}
    </textarea>

  <p>
    <label for="Dialogue">Dialogue.json</label>
    <textarea id="dialogue">
{

	"Introduction": "Hello, @!  That symbol I used tells me to use your name.  I can also use %farm to mention your farm.#$b#That is an uninterrupted break.. Keeps the dialogue going.#$e#This was a normal break... meaning you have to talk to me again.#$b#That should cover the basic dialogue.",
	"Mon": "Hey @, I got a quick question for you...#$b#$q 6000/6001 mon_template#Do you know how to make question events?#$r 6000 250 mon_yes#Sure do#$r 6001 500 mon_no#I don't know how",
	"mon_yes": "That's great to know... You should use them once in a while to help develop closer bonds to your NPC",
	"mon_no": "No? Well let's look at my question.#$b# The first part is the question indicator.. the dollar sign+ the q.. This tells the game that I am about to ask a question.#$b#The first set of numbers are my response IDs.  The game will store the response to these numbers. #$b#The mon_template is my fallback... how I talk to you after the question has been answered.#$b# The dollar sign + r indicates that you are starting responses, the first number is the ID of the response and the second number is how many friendship points it gives. One heart is 250 points.  It also needs a response dialogue from me as well.#$b#Notice that responses and questions are divided by hashtags.",
	"mon_template": "$p 6000#If you answered yes... You will see this dialogue.|If you did not, you will see this dialogue.",
	"Tue": "MissCoriel can be helpful in many dialogue and events.  You can reach her on discord!#$b# Her ID is MissCoriel#7989!",
	"Wed": "Portrait expressions are important to convey the scene.$1#$b#When making portraits, remember this:#$b#1 is happy, 2 is sad, 3 is unique, 4 is blushing, 5 is angry.#$b#You can have up to 12 portraits as far as I know.",
	"Thu": "Some dialogue is found elsewhere in the contents.. I will help you find the most relavent.",
	"Fri": "You can also give people items like this. [70]#$b#Use Cane's Resource to see Item IDs and other important things.",
	
}
    </textarea>

  <p>
    <label for="marriageDialogue">MarriageDialogue.json</label>
    <textarea id="marriageDialogue">
{    
	"Rainy_Day_0": "  ",
    "Rainy_Day_1": "  ",
    "Rainy_Day_2": "  ",
    "Rainy_Day_3": "  ",
    "Rainy_Day_4": "  ",
    "patio_NPCName": " You need to declare the spouse name. (Example: patio_Haley)",
    "Rainy_Day_NPCName": "Be sure to put your NPC's name.",
    "Rainy_Night_0": "  ",
    "Rainy_Night_1": "  ",
    "Rainy_Night_2": "  ",
    "Rainy_Night_3": "  ",
    "Rainy_Night_4": "  ",
    "Rainy_Night_5": "  ",
    "Rainy_Night_NPCName": "  ",
    "Indoor_Day_0": "  ",
    "Indoor_Day_1": "  ",
    "Indoor_Day_2": "  ",
    "Indoor_Day_3": "  ",
    "Indoor_Day_4": "  ",
    "Indoor_Day_NPCName": "  ",
    "Indoor_Night_0": "  ",
    "Indoor_Night_1": "  ",
    "Indoor_Night_2": "  ",
    "Indoor_Night_3": "  ",
    "Indoor_Night_4": "  ",
    "Indoor_Night_NPCName": "Don't forget to fill in your NPC's Name",
    "Outdoor_0": "  ",
    "Outdoor_1": "  ",
    "Outdoor_2": "  ",
    "Outdoor_3": "  ",
    "Outdoor_4": "  ",
    "Outdoor_NPCName": "Don't forget to fill in your NPC's Name",
    "funLeave_NPCName": "Don't forget to fill in your NPC's Name",
    "funReturn_NPCName": "Don't forget to fill in your NPC's Name",
    "OneKid_3": "You can have 3 of these",
    "TwoKids_0": "  ",
    "TwoKids_2": "  ",
    "TwoKids_3": "  ",
    "Good_1": "  ",
    "Good_2": "  ",
    "Good_3": "  ",
    "Good_4": "  ",
    "Good_5": "  ",
    "Good_6": "  ",
    "Good_7": "  ",
    "Neutral_0": "  ",
    "Neutral_1": "  ",
    "Neutral_6": "  ",
    "Neutral_7": "  ",
    "Neutral_8": "  ",
    "Neutral_9": "  ",
    "Bad_7": "  ",
    "Bad_8": "  ",
    "Bad_9": "  ",

}
    </textarea>
</div>
<hr>
<button onclick="generate()">Create content pack</button>

<script>
  var itemsXhr = new XMLHttpRequest();
  itemsXhr.responseType = 'json';
  itemsXhr.onload = function() {
      var items = document.querySelector('#items');
      var itemsData = itemsXhr.response['content'];
      for (const item of Object.keys(itemsData)) {
          var option = document.createElement('option');
          option.value = item;
          option.textContent = itemsData[item].split('/')[0];
          items.appendChild(option);
      }
  };
  itemsXhr.onerror = function(e) {
      console.error(e);
  };
  itemsXhr.open("GET", "ObjectInformation.json", true);
  itemsXhr.send();

  function addItem(id) {
      var elem = document.createElement('li');
      var inner = document.createElement('span');
      inner.className = "item-value";
      var items = document.querySelector('#items');
      inner.value = items.value;
      elem.textContent = items.options[items.selectedIndex].textContent;
      elem.appendChild(inner);
      var remover = document.createElement('span');
      remover.className = "item-remover";
      remover.onclick = function() {
          this.parentNode.remove();
      };
      remover.textContent = "[X]";
      elem.appendChild(remover);
      document.getElementById(id).appendChild(elem);
  }

  var allSchedules = [];
  function regenerateSchedules(schedules) {
      var list = document.querySelector("#schedules-list");
      list.innerHTML = "";
      for (const schedIdx in allSchedules) {
          const s = allSchedules[schedIdx];
          var item = document.createElement("li");
          const labels = {
              "seasonal": "Every day in {season}",
              "day-of-week": "Every {day}",
              "day-of-week-season": "Every {day} in {season}",
              "month-day": "Every day {date} in all seasons",
              "season-day": "Every day {date} in {season}",
              "rain": "Every rainy day",
          };
          var label = labels[s.type];
          for (const key of Object.keys(s.conditions)) {
              label = label.replace("{" + key + "}", s.conditions[key]);
          }
          item.appendChild(document.createTextNode(label));

          var edit = document.createElement("button");
          edit.textContent = "edit";
          edit.onclick = function(idx) {
              currentSchedule = {
                  elements: allSchedules[idx].elements,
              };
              currentScheduleIdx = idx;
              editSchedule(allSchedules[idx].type, allSchedules[idx].conditions);
          }.bind(null, schedIdx);
          item.appendChild(edit);

          var deleteButton = document.createElement("button");
          deleteButton.textContent = "delete";
          deleteButton.onclick = function(idx) {
              allSchedules.splice(idx, 1);
              regenerateSchedules();
          }.bind(null, schedIdx);
          item.appendChild(deleteButton);

          list.appendChild(item);
      }
  }

  function coordToTileCoord(coord) {
      return {
          x: Math.trunc(coord.x / 16) * 16,
          y: Math.trunc(coord.y / 16) * 16,
      };
  }

  function redrawMap(map, hovered, selected, newMap) {
      if (newMap) {
          selectedCoords = null;
      }
      ctx.globalAlpha = 1.0;
      ctx.canvas.width = mapImages[map].width
      ctx.canvas.height = mapImages[map].height;
      ctx.drawImage(mapImages[map], 0, 0);
      if (hovered) {
          var tile = coordToTileCoord(hovered);
          ctx.globalAlpha = 0.4;
          ctx.fillStyle = "white";
          ctx.fillRect(tile.x, tile.y, 16, 16);
      }
      if (selected) {
          ctx.globalAlpha = 0.4;
          ctx.fillStyle = "red";
          var tile = coordToTileCoord(selected);
          ctx.fillRect(tile.x, tile.y, 16, 16);
          ctx.strokeStyle = "white";
          ctx.strokeRect(tile.x, tile.y, 16, 16);
      }
  }

  function canvasMouseCoordinates(canvas, evt) {
      var rect = canvas.getBoundingClientRect();
      return {
          x: evt.clientX - rect.left,
          y: evt.clientY - rect.top
      };
  }

  var mapImages = {};
  var maps = ["Town", "Beach", "Mountain", "BusStop", "Forest", "Saloon", "Backwoods"];
  var selectedImage = document.querySelector('#mapImage');
  for (const m of maps) {
      mapImages[m] = new Image();
      mapImages[m].src = m + ".png";
      var opt = document.createElement('option');
      opt.textContent = m;
      opt.value = m;
      selectedImage.appendChild(opt);
  }
  var selectedCoords = null;
  var canvas = document.querySelector('#map');
  canvas.onmousemove = function(evt) {
      var coords = canvasMouseCoordinates(canvas, evt);
      redrawMap(selectedImage.value, coords, selectedCoords, false);
  };
  canvas.onclick = function(evt) {
      var coords = canvasMouseCoordinates(canvas, evt);
      selectedCoords = coords;
      redrawMap(selectedImage.value, coords, selectedCoords, false);
  };
  var ctx = canvas.getContext('2d');
  mapImages[selectedImage.value].onload = () => redrawMap(selectedImage.value, null, null);

  function generate() {
      var manifest = {};
      manifest["Name"] = document.querySelector('#modName').value;
      manifest["Author"] = document.querySelector('#author').value;
      manifest["Description"] = document.querySelector('#description').value;
      manifest["Version"] = document.querySelector('#version-major').value + '.' +
          document.querySelector('#version-minor').value + '.' +
          document.querySelector('#version-patch').value;
      manifest["UniqueID"] = manifest["Author"].replace(' ', '_') + "." +
          manifest["Name"].replace(' ', '_');
      manifest["ContentPackFor"] = { "UniqueID": "Pathoschild.ContentPatcher" };
      manifest["UpdateKeys"] = [ "" ];

      var content = {};
      content["Format"] = "1.9";
      var changes = [];

      var manifestationEntries = {};
      var npcName = document.querySelector("#npc-name").value;
      manifestationEntries[npcName] = [
          document.querySelector('#npc-age').value,
          document.querySelector('#npc-manners').value,
          document.querySelector('#npc-anxiety').value,
          document.querySelector('#npc-optimism').value,
          document.querySelector('#npc-gender').value,
          document.querySelector('#npc-datable').checked ? "datable" : "not-datable",
          "",
          document.querySelector('#npc-home').value,
          document.querySelector('#npc-birthday-season').value + " " +
              document.querySelector("#npc-birthday-date").value,
          (document.querySelector('#npc-mother').value ?
           document.querySelector('#npc-mother').value + " 'mom' " : "") +
              (document.querySelector('#npc-father').value ?
               document.querySelector('#npc-father').value + " 'dad'" : ""),
          document.querySelector('#npc-default-map').value + " " +
              document.querySelector('#npc-default-x').value + " " +
              document.querySelector('#npc-default-y').value,
          npcName,
      ].join('/');

      changes.push({
          "LogName": "NPC Manifestation",
          "Action": "EditData",
          "Target": "Data/NPCDispositions",
          "Entries": manifestationEntries,
      });

      function appendItems(list, id) {
          list.push(document.getElementById(id + '-text').value);
          var items = [];
          var allItems = document.querySelectorAll('#' + id + ' li span.item-value');
          for (const e of allItems) {
              items.push(e.value);
          }
          list.push(items.join(' '));
      }

      var giftEntries = {};
      giftEntries[npcName] = [];
      var lists = ['npc-gift-love', 'npc-gift-like', 'npc-gift-dislike', 'npc-gift-hate'];
      for (const list of lists) {
          appendItems(giftEntries[npcName], list)
      }
      giftEntries[npcName].push(document.querySelector('#npc-birthday-gift-text').value);
      giftEntries[npcName] = giftEntries[npcName].join('/');

      changes.push({
          "LogName": "NPC Gift Tastes",
          "Action": "EditData",
          "Target": "Data/NPCGiftTastes",
          "Entries": giftEntries,
      });

      changes.push({
          "LogName": "Animations",
          "Action": "EditData",
          "Target": "Data/animationDescriptions",
          "Entries": {}, // TODO
      });

      changes.push({
          "LogName": "EngagementDialogue",
          "Action": "EditData",
          "Target": "Data/EngagementDialogue",
          "Entries": {}, // TODO
      });

      changes.push({
          "LogName": "Schedule Dialogue",
          "Action": "Load",
          "Target": "Strings/schedules/" + npcName,
          "FromFile": "assets/Schedule/ScheduleDialogue.json",
      });

      // FIXME: support uploading arbitrary portrait image
      changes.push({
          "LogName": npcName + " Portraits",
          "Action": "Load",
          "Target": "Portraits/" + npcName,
          "FromFile": "assets/Image/" + npcName + ".png",
      });

      // FIXME: support uploading arbitrary sprite image
      changes.push({
          "LogName": npcName + " Sprites",
          "Action": "Load",
          "Target": "Characters/" + npcName,
          "FromFile": "assets/Image/" + npcName + "Sprites.png",
      });

      changes.push({
          "LogName": "Dialogue",
          "Action": "Load",
          "Target": "Characters/Dialogue/" + npcName,
          "FromFile": "assets/Dialogue/Dialogue.json",
      });

      changes.push({
          "LogName": "Schedule",
          "Action": "Load",
          "Target": "Characters/schedules/" + npcName,
          "FromFile": "assets/Schedule/Schedule.json",
      });

      // TODO: events

      content["Changes"] = changes;

      var schedule = document.querySelector('#schedule').textContent;
      var scheduleDialogue = document.querySelector('#scheduleDialogue').textContent;
      var dialogue = document.querySelector('#dialogue').textContent;
      var marriageDialogue = document.querySelector('#marriageDialogue').textContent;

      var zip = new JSZip();
      zip.file("manifest.json", JSON.stringify(manifest, undefined, 4));
      zip.file("content.json", JSON.stringify(content, undefined, 4));
      var assets = zip.folder("assets");
      var scheduleDir = assets.folder("Schedule");
      scheduleDir.file("Schedule.json", schedule);
      scheduleDir.file("ScheduleDialogue.json", scheduleDialogue);
  
      var dialogueDir = assets.folder("Dialogue");
      dialogueDir.file("Dialogue.json", dialogue);
      dialogueDir.file("MarriageDialogue.json", marriageDialogue);

      var image = assets.folder("Image");

      zip.generateAsync({type:"blob"})
          .then(function(content) {
              saveAs(content, "example.zip");
          });
  }

  function switchTab(id) {
      var tabs = document.querySelectorAll('.stuff');
      for (const tab of tabs) {
          tab.classList.add("hidden");
      }
      document.getElementById(id).classList.remove("hidden");
      var tabs = document.querySelectorAll('#tabs span');
      for (const tab of tabs) {
          tab.classList.remove('active');
      }
      document.getElementById("tab-" + id).classList.add("active");
  }

  var currentSchedule;
  var currentScheduleIdx = null;
  function newSchedule() {
      currentSchedule = {
          elements: [],
      };
      currentScheduleIdx = null;
      editSchedule();
  }

  function editSchedule(type, keys) {
      document.querySelector("#schedules-all").classList.add("hidden");
      document.querySelector("#schedule-new").classList.remove("hidden");
      if (type !== undefined) {
          var types = document.querySelector("#schedule-type");
          for (const idx in types.options) {
              if (types.options[idx].value == type) {
                  types.selectedIndex = idx;
              }
          }
          for (const k of Object.keys(keys)) {
              var select = document.getElementById("schedule-" + k);
              for (const idx in select.options) {
                  if (select.options[idx].value == keys[k]) {
                      select.selectedIndex = idx;
                  }
              }
          }
      }
      scheduleTypeChanged();
      recreateSchedule();
  }

  function scheduleTypeChanged() {
      var selected = document.querySelector("#schedule-type").value;
      var selectors = document.querySelectorAll('.schedule-type-selector');
      for (const s of selectors) {
          s.classList.add('hidden');
      }
      const components = {
          "seasonal": ["schedule-season"],
          "day-of-week": ["schedule-day"],
          "day-of-week-season": ["schedule-season", "schedule-day"],
          "month-day": ["schedule-date"],
          "season-day": ["schedule-season", "schedule-date"],
          "rain": [],
      };
      for (const id of components[selected]) {
          document.getElementById(id).classList.remove('hidden');          
      }
  }

  function discardSchedule() {
      document.querySelector('#schedules-all').classList.remove("hidden");
      document.querySelector('#schedule-new').classList.add("hidden");
      currentSchedule = null;
      if (currentScheduleIdx !== null) {
          console.log("discarding existing schedule");
          allSchedules.splice(currentScheduleIdx, 1);
      }
      regenerateSchedules();
  }

  function addScheduleComponent() {
      var last = currentSchedule.elements.length > 0 ?
          currentSchedule.elements[currentSchedule.elements.length - 1] :
          null;
      currentSchedule.elements.push({
          hour: last ? last.hour : "6",
          minute: last ? last.minute : "00",
          map: last ? last.map : null,
          x: last ? last.x : null,
          y: last ? last.y : null,
          facing: 0,
      });
      recreateSchedule();
  }

  // TODO: support reusing existing schedules with different conditions (GOTO)
  // TODO: support schedule friendship checks
  // TODO: support fallback conditions (eg. 11_6 in Abigail.json)

  function finishSchedule() {
      var selected = document.querySelector("#schedule-type").value;
      var season = document.querySelector("#schedule-season").value;
      var date = document.querySelector("#schedule-date").value;
      var day = document.querySelector("#schedule-day").value;
      const seasonalKinds = ["seasonal", "day-of-week-season", "season-day"];
      const dayKinds = ["day-of-week", "day-of-week-season"];
      const dateKinds = ["month-day", "season-day"];
      var schedule = {
          "type": selected,
          "conditions": {},
          "elements": currentSchedule.elements,
      };
      if (seasonalKinds.indexOf(selected) != -1) {
          schedule.conditions.season = season;
      }
      if (dayKinds.indexOf(selected) != -1) {
          schedule.conditions.day = day;
      }
      if (dateKinds.indexOf(selected) != -1) {
          schedule.conditions.date = date;
      }
      if (currentScheduleIdx === null) {
          allSchedules.push(schedule);
      } else {
          allSchedules[currentScheduleIdx] = schedule;
          currentScheduleIdx = null;
      }
      discardSchedule();
  }

  var currentScheduleElement = null;
  function recreateSchedule() {
      var list = document.querySelector("#schedule-components");
      list.innerHTML = "";
      for (const idx in currentSchedule.elements) {
          const c = currentSchedule.elements[idx];
          var item = document.createElement('li');
          var hour = document.createElement('select');
          hour.onchange = function(idx) {
              currentSchedule.elements[idx].hour = hour.value;
          }.bind(null, idx);
          for (var h = 0; h <= 24; h++) {
              var elem = document.createElement('option');
              if (h.toString() == currentSchedule.elements[idx].hour) {
                  elem.defaultSelected = true;
              }
              elem.textContent = h.toString();
              hour.appendChild(elem);
          }
          item.appendChild(hour);
          item.appendChild(document.createTextNode(':'));
          var minute = document.createElement('select');
          minute.onchange = function(idx) {
              currentSchedule.elements[idx].minute = minute.value;
          }.bind(null, idx);
          for (var m = 0; m < 60; m += 10) {
              var elem = document.createElement('option');
              minString = m.toString();
              if (minString.length < 2) {
                  minString = "0" + minString;
              }
              if (m.toString() == currentSchedule.elements[idx].minute) {
                  elem.defaultSelected = true;
              }
              elem.textContent = minString;
              minute.appendChild(elem);
          }
          item.appendChild(minute);
          if (currentSchedule.elements[idx].x !== null && currentSchedule.elements[idx].x !== null) {
              item.appendChild(document.createTextNode(
                  "at " + currentSchedule.elements[idx].x + ", " +
                      currentSchedule.elements[idx].y +
                      " (" + currentSchedule.elements[idx].map + ")"
              ));
          }
          var posSelect = document.createElement('button');
          posSelect.onclick = function(idx) {
              document.querySelector('#schedule-new-choose-position').classList.remove('hidden');
              document.querySelector('#schedule-new').classList.add('hidden');
              currentScheduleElement = currentSchedule.elements[idx];
              var images = document.querySelector("#mapImage");
              for (const imageIdx in images.options) {
                  if (images.options[imageIdx].value == currentScheduleElement.map) {
                      images.selectedIndex = imageIdx;
                  }
              }
              if (currentScheduleElement.x !== null && currentScheduleElement.y !== null) {
                  selectedCoords = {
                      x: currentScheduleElement.x * 16,
                      y: currentScheduleElement.y * 16,
                  };
              }
              redrawMap(images.value, null, null, false);
          }.bind(null, idx);
          posSelect.textContent = "Choose position";
          item.appendChild(posSelect);

          item.appendChild(document.createTextNode('facing'));
          var facing = document.createElement('select');
          facing.onchange = function() {
              currentSchedule.elements[idx].facing = facing.value;
          }.bind(null, idx);
          var dirs = ["up", "right", "down", "left"];
          for (var facingIdx in dirs) {
              var opt = document.createElement('option');
              if (facingIdx == currentSchedule.elements[idx].facing) {
                  opt.defaultSelected = true;
              }
              opt.value = facingIdx;
              opt.textContent = dirs[facingIdx];
              facing.appendChild(opt);
          }
          item.appendChild(facing);

          list.appendChild(item);
      }
  }

  function chooseSelectedPosition() {
      if (selectedCoords === null) {
          cancelChoosePosition();
          return;
      }
      var coords = coordToTileCoord(selectedCoords);
      currentScheduleElement.x = coords.x / 16;
      currentScheduleElement.y = coords.y / 16;
      currentScheduleElement.map = document.querySelector('#mapImage').value;
      cancelChoosePosition();
  }

  function cancelChoosePosition() {
      selectedCoords = null;
      currentScheduleElement = null;
      document.querySelector('#schedule-new-choose-position').classList.add('hidden');
      document.querySelector('#schedule-new').classList.remove('hidden');
      recreateSchedule();
  }

  for (var i = 1; i <= 28; i++) {
      var opt = document.createElement('option');
      opt.textContent = i;
      document.querySelector('#schedule-date').appendChild(opt);
  }

  switchTab('schedule');
</script>
